---
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: yes
  pdf_document:
    toc: no
  word_document: default
  html_document: default
bibliography: IBMWG.bib
fontsize: 12pt
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{lineno}
- \linenumbers
- \usepackage[belowskip=0pt,aboveskip=0pt]{caption}
 \usepackage{array}
 \usepackage{caption}
 \usepackage{graphicx}
 \usepackage{siunitx}
 \usepackage{colortbl}
 \usepackage{multirow}
 \usepackage{hhline}
 \usepackage{calc}
 \usepackage{tabularx}
 \usepackage{tabulary}
 \usepackage{threeparttable}
 \usepackage{wrapfig}
---

```{r setup, include=FALSE}

library("knitr")
library("kableExtra")
library("dplyr")
library("readr")
library("tidyr")
library("forcats")


knitr::opts_chunk$set(echo = FALSE)
if(!require(kableExtra)) {  
  install.packages("kableExtra")
  require(kableExtra)}



#read in results tables
YT_results<-read.csv("CSVs/Yellowtail_results.csv")
Cod_results<-read.csv("CSVs/Cod_results.csv")
Had_results<-read.csv("CSVs/Haddock_results.csv")
```


\newpage

# Estimating Population Trends with Stratified Random Sampling Under the Pressures of Climate Change

  
Benjamin A. Levy^1^, Christopher M. Legault^2^, Timothy J. Miller^2^, Elizabeth N. Brooks^2^



^1^Ben's Institution, USA  
^2^National Marine Fisheries Service, Northeast Fisheries Science Center, Woods Hole, MA, USA  
  

Corresponding author: Ben Levy (benjamin.levy@noaa.gov)

Competing interests: The authors declare there are no competing interests.

<!-- [[Chris comments in double square brackets, search for them to see comments]] -->

<!-- Table1 <- YT_results -->

<!-- write.table( -->
<!--    format(f, digits=2), "", -->
<!--    sep="|", row.names=F, col.names=F, quote=F, eol="|\n") -->

\newpage

## Abstract

An Abstract

## Keywords

keyword 1, keyword 2

\newpage

\section{Introduction}


<!-- much of below is from https://apps-nefsc.fisheries.noaa.gov/nefsc/ecosystem-ecology/ -->
<!-- or -->
<!-- https://www.fisheries.noaa.gov/data-tools/fisheries-economics-united-states-data-and-visualizations -->


<!-- - The eastern continental shelf is ecologically diverse and economically important -->


The Northeast United States continental shelf spans from the Outer Banks of North Carolina to the Gulf of Maine. The region covers over 250,000 km$^2$ of ocean, extending over 200 km from shore in the largest areas in New England to just 30 km off shore in the southern regions. This ecologically diverse region contains approximately 18,000 vertebrate marine species. Commercial fisheries have been an important part of local economies for centuries. In 2019, New England fisheries produced $22 billion in sales, which sustained over 200,000 jobs. Maintaining a healthy ecosystem is therefore vital to sustained ecological health and economic prosperity of the region.


<!-- - Bottom trawl survey is important for monitoring population trends -->

The NEFSC has conducted a bottom trawl survey since 1963 to support assessment and management of the fish and invertebrate populations in the region [@azarovitz1981brief; @politis2014northeast]. The survey uses a stratified random design where bottom trawl sampling takes place in predefined strata along the eastern continental shelf. The survey has created a rich time series data set with many uses including species-specific habitat identification, analysis of how environmental conditions influence species abundance, and estimating yearly species abundance trends to help inform stock assessments and ultimately quota limits. The survey takes place twice each year- once in the spring and again in the fall. Since most spatial analyses and  projections of future distributions typically assume a constant survey catchability and/or availability over time, NOAA's survey design includes sampling Georges Bank during approximately the same 3-4 week time period in each season. 


<!-- - Climate change is happening -->

Due to a combination of climate change and shifts in circulation, the Northeast United States continental shelf has experienced rapid warming in recent decades, resulting in a shift in spatial distributions of many species. Since stock assessment models rely on accurate descriptions of population dynamics and contemporary patterns of spatial abundance, there is concern that rapid undocumented changes in spatial distributions of species will bias future stock assessments. More specifically, as fish populations shift their distributions over time, catchability and/or availability in the survey will change, altering the relationship between the index and the true population. We are therefore interested in analyzing the impact of climate change on the accuracy of future stock assessment models as measured by NOAA’s ongoing bottom-trawl survey along the East coast.


**use more info from initial proposal**

<!-- Agree that could bulk up the above paragraph with references from the initial proposal, along with more recent refs like https://doi.org/10.1016/j.fishres.2023.106652, DOI 10.1007/s11160-016-9444-z, https://doi.org/10.1093/icesjms/fsac140, etc. Don't want to lose connection with the next paragraph, so don't get lost in the weeds. -->

<!-- - Briefly describe our study to test this -->

To test the ability of the bottom trawl survey to track population trends under shifting environmental conditions, we construct spatial models for fish where movement depend on temperature preferences. We consider the impact of climate change by comparing simulations that use a repeating temperature pattern to those where temperature increases on average over time. In both cases we analyze the ability of stratified random sampling to track population trends.  

<!-- General note: we should do a sweep through entire document and change everything to past tense. This is the typical verb tense in fisheries papers (I know present tense is used in other fields). In above paragraph, need to add VAST and VAST with covariates. -->

\section{Methods}

<!-- - Describe simulation study -->

We construct spatial models for Yellowtail Flounder, Atlantic Cod, and Haddock on Georges Bank, where movement of each species combine static species-specific habitat preferences with temperature preferences. Model dynamics are driven by a time series of temperature gradients that were estimated from data to create simulated data sets for each population where the true biomass is known. Using temperature gradients that repeat each year creates data sets with predictable, repeating spatial patterns, whereas using a temperature gradient that increases on average throughout the simulation leads to spatial distributions that shift over time. We conduct stratified random sampling on our simulation output to mimic the bottom trawl survey and use the samples to compare the ability of contemporary indexing methods to track population trends. 

\subsection{Population Model Formulation}


<!-- -- Used MixFishSim. -->

We use the R package *MixFishSim* (MFS) to model our populations [@dolder2020highly]. MFS is a discrete spatiotemporal simulation tool where users can model multiple species under varying environmental conditions. The package uses a delay-difference population model with discrete processes for growth, death, and recruitment of the population. We formulate the following inputs for the MFS package to address our research question.


<font size="5">*Study Area*</font>

We obtained a shapefile for the 15 strata that comprise Georges Bank, where strata were partitioned based primarily on depth and secondarily by latitude [@politis2014northeast]. The region was discritized into a raster with 88 rows and 144 columns to use as our modeling environment. A fish stock is considered to be a subpopulation of a species that has similar intrinsic parameters. Each of the species being modeled has multiple distinct stocks along the Atlantic coast resulting from local environmental conditions. Biological differences between species results in each stock inhabiting a different number of strata on Georges Bank. Haddock inhabit all 15 strata in the domain, Cod inhabit 13 strata, and Yellowtail exist in 9 strata. Figure \@ref(fig:strata-plot) shows the regions used in our models. 

<!-- In the second sentence above, can we give a general size of the space occupied by each cell in our study? I know it varies by latitude, but I think an approximate size would be useful for readers to demonstrate that we are dealing with relatively small scale phenomena in the simulations. I stumbled over inhabit, inhabit, exist in the final sentence. I don't have a good suggestion for fixing it, just noting that the different final term caught my eye and made me ask if yellowtail were different from cod and haddock somehow. -->

```{r strata-plot, echo=FALSE,out.width="95%",fig.show='hold', fig.align='center', fig.cap="Strata inhabited by each species in our population models."}
#knitr::include_graphics(c("Images/Strata.png"))
#knitr::include_graphics(c("Images/Excluded_strata.png"))
knitr::include_graphics(c("Images/Strata2.png"))
knitr::include_graphics(c("Images/Excluded_strata2.png"))
```

<font size="5">*Population Dynamics and Recruitment*</font>

The time step for our models is one week. MFS uses a modified two-stage Deriso-Schnute delay difference equation that models the biomass in each cell in our study area [@dolder2020highly]. Individual terms in the formulation account for growth of mature adults, natural and fishing mortality, and the addition of new recruits. We chose to represent recruitment in the model using a Beverton-Holt formulation **cite**. Recruitment is a function of the adult biomass that existed in the previous year and is added to the population incrementally throughout each species' predefined spawning period. Parameter inputs were either obtained from the literature or chosen to produce desired model dynamics. A full list of parameters used in our model can be seen below in Tables \@ref(paramsALL) and \@ref(tab:paramsSCENARIOS). 

<!-- I think we can delete the sentence about using Beverton-Holt recruitment because it appear in the table.  -->

<font size="5">*Movement*</font>

The package combines species-specific temperature tolerances with habitat preferences to drive the probability of movement from cell $I$ to cell $J$ using the formulation

\begin{align}
Pr(C_{wk+1}=J|C_{wk}=I) = \frac{e^{-\lambda \cdot d_{I,J}}\cdot(Hab^2_{J,s} \cdot Tol_{J,s,wk})}{\sum^C_{c=1}e^{-\lambda \cdot d} \cdot (Hab^2_{c,s} \cdot Tol_{c,s,wk})},
\label{moveP}
\end{align}


 where 
 

   $e^{-\lambda \cdot d_{I,J}}$ accounts for distance between cells $I$ and $J$,
     
  $Hab^2_{J,s}$ is the static habitat value for species $s$ in cell $J$, and
    
   $Tol_{c,s,wk}$ is the value from normally distributed temperature tolerance for species $s$ in cell $c$ in week $wk$.


The package was designed to generate hypothetical temperature gradients and theoretical habitat preferences using Gaussian Random Fields. The following sections describe how we formulated the habitat and temperature components to model real species in the western Atlantic Ocean.

<font size="5">*Habitat Input*</font>

Species-specific habitat preferences were derived from niche model for each species using the *lrren* tool from the R package *envi* [@envi]. The *lrren* tool estimates an ecological niche using the relative risk function by relating presence/absence data to two covariate predictors. We used bottom trawl point data in from 2009-2021 as our presence/absence input by using a value of 0 for any tow that failed to catch the given species and weighting a successful catch by the biomass of the given tow. We combined data from both the fall and spring surveys to obscure the influence of temperature so that the niche model would instead infer habitat preferences. Depth and mean sediment size were used as our covariate predictors. Estimated depth for the region was obtained from FVCOM [@chen2006unstructured]. The mean sediment size raster was interpolated in ArcMap using the natural neighbor interpolation method **cite arcmap** using point data collected by the United States Geologic Survey (USGS) [@mcmullen2005usgs]. Since the values in $Hab_{J,s}$ are required to be between 0 and 1, we transform the spatial estimates from *lrren* to fall between these bounds. See Figure \@ref(fig:hab-plot1) for a visual representation of this process being applied to Cod. Figure \@ref(fig:hab-plot) depicts habitat preferences $Hab_{J,s}$ for each species.


```{r hab-plot1, echo=FALSE,out.width="95%",fig.show='hold', fig.align='center', fig.cap="Visual representation of niche model for Cod."}
knitr::include_graphics(c("Images/hab_snip3.png"))
```


```{r hab-plot, echo=FALSE,out.width="95%",fig.show='hold', fig.align='center', fig.cap="Static habitat preferences for each species in our population models (Yellotwtail, Cod, Haddock)."}
knitr::include_graphics(c("Images/Habitat_3species.png"))
```

<font size="5">*Temperature Input*</font>

Each species is assumed to have normally distributed temperature preferences ($N(\mu,\sigma)$). Values were chosen by combining information in the literature with temperatures recorded in the bottom trawl survey. We assume Yellowtail Flounder's preferences are $N(8.75,4.25)$, while Haddock and Cod have preferences $N(9,4)$. Weekly estimated temperature data for the region for 2012 was obtained from FVCOM [@chen2006unstructured]. We chose to repeat estimates for a single year rather than use data for consecutive years to reduce the number of factors impacting model dynamics while still incorporating real data. The 2012 data was chosen because it displayed an average temperature pattern that consistently oscillated between maximum and minimum temperature values, allowing for a smooth repeating yearly temperature pattern for the constant temperature scenario. The 2012 temperature data was also transformed to create an oscillating pattern that increases 5 degrees Celsius on average over the duration of the simulation. We chose a 5 degree increase over a 20 year simulation to allow temperature change to have a meaningful impact on dynamics while remaining within reasonable computational limits in terms of the length of the simulation. Figure \@ref(fig:temp-scenarios) depicts mean trends for the temperature scenarios used in our models. **dont forget to include animated gif in final submission**

```{r temp-scenarios, echo=FALSE,out.width="95%",fig.show='hold', fig.align='center', fig.cap="Mean trends of temperature data used in our model."}
knitr::include_graphics(c("Images/TempScenarios.png"))
```



<!-- --Describe difference between increasing and constant temperature scenarios (images?) -->

In equation (1), $Hab^2_{J,s}$ is constant for the duration of the simulation, while $Tol_{c,s,wk}$ changes each week. Using a temperature gradient that repeats every 52 weeks produces the same spatial preferences in a given week each year, resulting in consistent spatial biomass patterns. Scenarios where the temperature increases over time creates spatial preferences that evolve as the water warms, producing spatial biomass patterns that shift in a given week over the duration of the simulation. Thus, stratified random samples in scenarios with a repeating temperature pattern will have constant survey catchability and availability over time, which may not be true for increasing temperature scenarios due to evolving spatial preferences.
 


<!-- -- Describe each scenario that is considered -->

We consider 20 year simulations under three population parameter scenarios for each of our three species- a scenario where parameters result in each population increasing over time, one where the populations are relatively constant over time, and a scenario where the parameter combination results in each population decreasing over time. Each of these three scenarios is paired with a temperature gradient that repeats as well as one that increasing roughly 5 degrees Celsius over the duration of the 20 year simulation. We therefore simulate 6 scenarios for each population. 

<!-- I don't think this paragraph accurately represents what we did because we did the full factorial for yellowtail, but only some for cod and haddock. Need to think about how to restructure this paragraph to better reflect what we did. -->

<font size="5">*Simulating Bottom Trawl Survey and Population Indexing*</font>


<!-- -Describe post hoc sampling process and how data is used -->

After each simulation is complete, we mimic the bottom trawl survey by conducting stratified random sampling in each inhabited strata twice each year. We sample each strata in the same weeks in which the Spring and Fall surveys take place, and the number of the samples taken reflect true target values for each strata. Most strata contain enough cells that we were able to generate a list of sampling locations without replacement, allowing us to sample a unique random cell in each survey over the duration of the simulation. For strata that contain small numbers of cells, we generate a random sampling locations with replacement of cells previously sampled. We then use the biomass collected from our samples in contemporary population indexing methods to estimate population trends. Knowing the true population values in our simulations allows us to compare the error calculated from each estimation method.

<!-- Can we simplify the third and fourth sentences to say something like "Randomly selected cells were sampled each year."? I realize the current text is more accurate, but worry that we may be losing the readers in the details. -->

<!-- --Stratified mean vs VAST with and without covariates -->

Stock assessment scientists use samples from the bottom trawl survey to estimate the abundance for each fish stock. There are a number of approaches to obtain abundance estimates including traditional design-based estimates to model-based estimates that range in complexity. Design-based estimators rely on the design of the sampling scheme with the underlying assumption that the data being collected is representative of the population of interest. These methods do not account for spatial variation in samples or allow the inclusion of environmental influences. Model-based abundance estimates use statistical models to measure the relationship between response variables (such as presence or abundance) and predictor variables (such as environmental factors). Model-based estimators, such as General Linear Models (GLM), General Additive Model (GAM), and General Linear Mixed Models (GLMM), help account for complex relationships between variables and can help overcome problems with sampling design. 

We compare yearly abundance estimates obtained from the stratified mean to estimates obtained from the Vector-Autoregressive Spatio-temporal (VAST) model. The stratified mean is a design-based approach that calculates the geometric mean catch per tow and has traditionally been used with stratified random sample designs. VAST is a spatial delta-generalized linear mixed model that estimates both abundance (biomass) and probability of occurrence (presence/absence) [@thorson2019guidance]. If desired, VAST also allows users to include covariate data to better inform the model. Covariates can be static (eg. habitat preferences) or dynamics (eg. temperature). We explore whether including environmental predictors can help inform models and provide better abundance estimates, which is particularly relevant as climate change progresses. The stratified mean calculations are straightforward and quick, while VAST models require numerous user inputs and can take on the order of hours to complete.  

We follow the advice given in [@thorson2019guidance] to build VAST models to estimate biomass on Georges Bank using stratified random samples from our model output. In addition to exploring different link functions and assumed distributions, our VAST model-building process involved testing the impact of including spatial and/or spatio-temporal variation in our models, considering varying number of knots in our mesh, and testing different forms of temporal correlation. We also carried out the same process running models without covariate information as well as including covariates in our model. We considered covariates in the form of dynamic temperature values and/or static habitat values ($Hab_{J.s}$) from our population model. When using covariates we ultimately decided to provide the most information to the model by including both temperature and habitat covariates for both linear predictors. Knowing the true population values in our models allowed us to calculate the absolute error of each VAST estimate to compare between potential settings. Through this process, and in consultation with the VAST package creator, we ultimately compared the performance of two sets of settings in our VAST models, which can be seen in Table\@ref(tab:VASTsettings).

Our goal is to determine indexing approaches and settings that are robust to future environmental conditions and resulting spatial biomass patterns. An underlying assumption in all indexing methods is that individual random samples combine to accurately represent true abundance by a) containing a low enough noise level in the samples to allow for a discernible pattern and b) sampling all strata in which the population exists. These assumptions can be questioned given enough noise in the sampling process **cite?** and/or climate change causing a population to move into previously uninhabited strata. To simulate the impact of noise, we compare indexing estimates after adding noise to our samples versus those using the true sampling values. **BL: Help with correct notation for adding noise**. We simulate the effect of populations moving into new habitat by comparing indexing estimates using samples from all strata inhabited by each species on Georges Bank to those that only include a subset of the full spatial domain for each species. We chose strata to exclude for each species by reviewing how spatial preferences evolved in our increasing temperature scenarios and removing strata that each species either shifted into, or away from. Tabl XXX [[needs to be added]] lists all strata inhabited by each species, those that are removed from certain calculations, and the explanation of why these strata were removed.

<!-- Note the Table XXX needs to be added comment above. -->
When combining population trends for each species, differing temperature scenarios, altering seasons, and sampling possibilities (noise, strata, covariates) there are a large number of scenario combinations to consider. The columns in Table \@ref(tab:scenarios) show the choices that define each scenario.



```{r scenarios,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

options(knitr.kable.NA = '')


combos_table = read_csv("CSVs/scenario_combos.csv")

summary_tab <- combos_table %>% 
   mutate_if(grepl('5deg',.), ~replace(., grepl('5deg', .), paste("Increasing 5","\U00B0","C",sep=""))) 


# Create table to present the data]
 kable(summary_tab, "simple",
                     caption = "Each index estimate chooses one condition from each of the following
7 columns. There are 3∗3∗2∗2∗2∗2∗2 = 288 VAST model combinations and 3∗3∗2∗2∗2∗2 = 144 stratified mean estimates.",
          format = "latex", booktabs = TRUE) %>%
          kable_styling(latex_options = "scale_down")
```


\section{Results}

The goal of our project was to analyze the ability of contemporary population indexing methods to track population trends under a variety of conditions, as depicted in Table \@ref(tab:scenarios). Historically, Atlantic Cod has seen significant decline over the last XXX years while Haddock has increased in abundance in recent year [[can cite the 2022 management track assessments, see https://apps-nefsc.fisheries.noaa.gov/saw/sari.php for when the document becomes available]] **cite**. For this reason we compare indexing estimates using stratified random samples from decreasing population scenarios for Cod and increasing population scenarios for Haddock. To provide a comprehensive analysis of population indexing methods we consider all possible scenario combinations for Yellowtail Flounder. The specific population trends used in our analyses can be see in Figure \@ref(fig:pop-scenarios).

```{r pop-scenarios, echo=FALSE,out.width="99%",fig.show='hold', fig.align='center', fig.cap="True population trends used in indexing analyses. Spring biomass plots are shown with fall values being very similar."}
knitr::include_graphics(c("Images/Population_scenarios.png"))
```

Tables \@ref(tab:YTresultsallstrata), \@ref(tab:YTresultsreducedstrata), \@ref(tab:CodERROR), and \@ref(tab:HadERROR) contain the results of our comparison between the absolute error between abundance estimates and model output. General themes are that VAST estimates provide lower errors relative to those derived from the stratified mean, with VAST models that include covariate information providing the lowest overall errors and standard deviations. On the contrary, we also see individual cases where the stratified mean produced the lowest absolute error. When we reduce the number of strata that are included in indexing calculations to simulate species shifting into new territory, we typically see an increase in absolute error (as expected), though there are some scenarios where the impact is minimal. Furthermore, there are scenarios where including covariates in VAST models actually increases the absolute error, especially when we fail to sample the entire domain.  

In considering the Yellowtail Flounder results in Tables \@ref(tab:YTresultsallstrata) and \@ref(tab:YTresultsreducedstrata), we can see VAST estimates generally provide lower errors relative to those derived from the stratified mean, with models that include covariate information typically providing the lowest errors. When all strata are included on sampling, adding covariates greatly improved estimates in all scenarios. We still see an improvement in VAST estimates when certain strata are excluded from sampling, but the improvement was much less dramatic than with all strata included. However, there are several instances in which VAST failed to provide improved abundance estimates during the fall season without covariate information, producing the largest errors seen in Tables \@ref(tab:YTresultsallstrata) and \@ref(tab:YTresultsreducedstrata). These errors are corrected by including covariate information resulting in improved VAST estimates that are significantly lower than their stratified mean counterparts.

(see Table \@ref(tab:CodERROR)) In the Cod results, when using reduced strata in constant temperature, adding covariates produces worse VAST results (though still better than stratified mean). This is similar to what we see with all of Haddock results (adding covariates makes it worse with reduced strata). This is NOT seen with Yellowtail (adding covariates always helps). VAST without covariates much worse than stratified mean in fall with increasing temperature, but adding covariates corrects this and makes VAST estimates better than stratified mean.  

(see Table \@ref(tab:HadERROR)) For Haddock, VAST has a particularly hard time in spring regularly producing larger errors than the stratified mean with added covariates only improving to the level of the stratified mean. VAST shows improved results in fall relative to the stratified mean with added covariates producing extremely low errors in some cases. In Haddock results, adding covariates improves estimates only when all strata are included (when reduced strata, adding covariates actually makes VAST worse). Since this occurs in all scenarios, it seems to again be related to failing to accurately monitor strata 17.


<font size="5">*Differences Between VAST Settings*</font>

For YTF, 29/96 ~ 30% of VAST runs with new settings were better (70% were worse). 80/96 ~ 83% of scenarios had a VAST run with a better error than the stratified mean. 15/16 of the times the stratified mean was better VAST was not using covariates. The 1 time that VAST was using covariates and was still worse than the stratified mean was IncPop_IncTemp_Allstrata_WCov_WNoise in the Fall (VAST had strong overestimate in the fall during IncPOP_IncTemP_allstrata for Had and YT). The overestimate in the fall only seems to be related to the way the population shifts between season. Looking at the percent shift plots, the population is shifting out of strata 16 in both seasons (large east strata). In the spring the population is shifting mostly into strata 17 (thin strata adjacent to 16), but in the fall they are shifting into both 17 and 18 (18 thin one adjacent to 17). Thus it seems like with much of the population concentrated in the really small outer most strata, VAST produces an underestimate, even with covariates  

For Haddock (IncPop), 18/32 ~ 57% of VAST runs better with new settings. 24/32 = 75% of scenarios had a VAST run with a better error than the stratified mean. 14/16 VAST were better with covariates (the two that were worse were essentially the same) while only 10/16 were better without covariates. Stratified mean tended to perform better when all strata were included in the calculation, while VAST tended to perform better when strata are removed.

For Cod (DecPop), only 11/32 ~ 34% of VAST runs were better with new settings. 28/32~ 88% of scenarios had a VAST run with a better estimate than the stratified mean. All 16/16 = 100% of VAST runs with a covariate were better than the stratified mean. 12/16 VAST were better without covariates. The 4 runs without covariates that were worse were all extremely large errors and all from increasing temp in the fall (with and without all strata and noise). In the fall the population is moving out of strata 16 (large eastern strata) and 21 (north large) and into a number of strata (22 (tiny north), 24 (large north), 18 (tiny north)). Might be having trouble tracking in to smaller strata again.

<!-- [[We'll want to expand the results section to focus on the impact of each factor one at at time within each species. This will be a bit dull, but it is important to walk through the results in words to ensure that readers get the message. They can of course examine the tables in detail and draw their own conclusions, but we should put our interpretation down on paper.]] I think the above paragraphs are addressing this comment, but wanted to be sure they are not just "notes to self" before providing comments on them. -->

<!-- # ```{r} -->
<!-- # -->
<!-- # -->
<!-- # knitr::kable(YT_results, caption = "Yellowtail error results") -->
<!-- # -->
<!-- # knitr::kable(Cod_results, caption = "Cod error results") -->
<!-- # -->
<!-- # knitr::kable(Had_results, caption = "Haddock error results") -->
<!-- # ``` -->

Figure \@ref(fig:PopPct) depicts the spatial shifting that occurs in each strata within our population models, specifically during the bottom trawl survey weeks in the spring (13 and 14) and fall (37 and 28). See Figure \@ref(fig:strata-plot) for a spatial reference of the Georges Bank strata and Figure \@ref(fig:hab-plot) for the static habitat preferences for each species ($Hab^2_{J,s}$) used in our population models. 


<font size="5">*Yellowtail Flounder Results*</font>

The top two panels in Figure \@ref(fig:PopPct) depict the results for Yellowtail Flounder with a repeating temperature gradient on the left (constant temperature) and a temperature gradient that increases over time on the right (increasing temperature). In both temperature scenarios we see the percent of Yellowtail Flounder in strata 13 decrease over the course of the time series in both seasons. The spring population in stratum 19 also decreases in both temperature scenarios as well. The percent of the population increases in stratum 16 in the spring over the duration of both time series, which implies the flow out of strata 13 and 19 in the spring are going into stratum 16. These dynamics occur in both temperature scenarios in weeks 13 and 14 because stratum 16 contains favorable habitat for Yellowtail Flounder that coincides with most of the areas we have designated as the species' spawning ground, which takes place in weeks 9-12. These spring dynamics are therefore related to the static habitat values in our model rather than the dynamics temperature preferences. While we observe similar dynamics in the fall (weeks 37 and 38) in the constant temperature scenario, an increasing average temperature results in a decrease in population in stratum 16 over time and corresponding increases in strata 17 and 18 (see Figure \@ref(fig:PopPct)). These dynamics imply that an increase in temperature results in the more shallow strata 16 becoming less desirable than the deeper and more narrow exterior strata 17 and 18. One noticeable seasonal difference in the constant temperature scenario for Yellowtail is how ~10\% of the population exists in the narrow exterior strata 17 in the fall, while seemingly none of the population exists in any of the exterior strata (14, 15, 17, 18) in the spring.


Tables \@ref(tab:YTresultsallstrata) and \@ref(tab:YTresultsreducedstrata) contain the absolute error between our abundance estimates for Yellowtail Flounder comparing design-based approach (stratified mean) with two settings for a model-based approach (VAST A \& B). Of all scenarios without covariates, $33/48\approx68$\% had a VAST fit with a lower relative error compared to the stratified mean estimate. All 15 of the covariate-free VAST estimates that resulted in a higher error than the stratified mean were for the fall season and had a common theme of producing abundance estimates that are above the true model value. These 15 fall estimates span all other scenario variations. The implication of this is that our model-based approach without covariates struggles with the primary seasonal difference for Yellowtail Flounder, which is that a larger percentage of the population exists in the narrow exterior strata (18 and/or 17). This theory is further supported by the fact that the absolute error in the increasing temperature scenarios increased dramatically in the fall season, when the combined percentage of the population in the outer strata 17 and 18 increased to over 40\% by the end of the simulation.

Including detailed covariate information made a noticeable difference in our Yellowtail Flounder model-based VAST estimates. All of the VAST estimates that included covariate information produced a lower relative error than the corresponding VAST model that did not include covariates. The largest improvements were seen in the increasing temperature scenarios. As a result, of the VAST estimates that included covariates information, $47/48\approx98$\% had a lower relative error than the corresponding stratified mean estimate. This implies that the covariate information helped our model-based estimate account for the design-based issues related to small strata that contain a large percentage of the population, which can become exacerbated in the increasing temperature scenario.

The performance of our abundance estimates tend to decrease under increasing temperature, with the most dramatic changes seen in our VAST estimates without covariates. One exception to this is when we use a stratified mean approach while the population is decreasing. Our analyses have found that the stratified mean tends to under estimate the true abundance and since these estimates are bounded below by zero, as the Yellowtail population decreases towards zero the difference between the estimate and the true value also decrease. That is, if the population is low enough, failing to appropriately sample the population in a design-based method produces the same result as appropriately sampling.


**For discussion: clearly our perfect covariate information made a big difference here, but the question is could we achieve similar results without "perfect" information? Which covariate is best? Good question for future research**



<font size="5">*Cod Results*</font>
 
We see a seasonal impact of an increasing average temperature in stratum 16 in the Cod results in Figure \@ref(fig:PopPct). In the constant temperature scenario for Cod, in both seasons the population is decreasing its presence in strata 19 and 20 over the duration of the simulation, while simultaneously increasing presence in stratum 16. However, an increase in average temperature in the fall drives the population out of strata 16 and 21, and into 18, 22, and 24 (see Figure \@ref(fig:hab-plot)). Similar to the Yellowtail Flounder population, stratum the habitat in stratum 16 acts as an attractor in both temperature scenarios in the spring when the water temperature is cooler. When the temperature increases over time the fall population begins to prefer the adjacent strata that are deeper and/or more northern than stratum 16.  

Of the abundance estimates without covariates, $12/16=75$\% had a VAST fit with a lower relative error compared to the stratified mean estimate. Including detailed covariate information in our Cod VAST estimates resulted in all $16/16=100\%$ having a lower relative error than the corresponding stratified mean estimate. The 4 scenarios without covariates that had a higher VAST error were each overestimates for the fall season that involved an increasing temperature gradient. Similar to Yellowtail Flounder results, Cod are shifting their spatial distribution into the smaller exterior strata in these conditions, which is decreasing the accuracy of the covariate-free VAST estimate. While adding covariates to these fits allowed for an improved error relative to the stratified mean, the VAST abundance still display an overestimate early in the time series before covariates correct the trend, allowing for a lower overall absolute error **(show these plots? IncTemp fall scenarios)**.



<font size="5">*Haddock Results*</font>

Figure \@ref(fig:PopPct) reveals some subtle seasonal differences in the percent of haddock in each strata. In the constant temperature scenarios, the spring shows a decrease in strata 19 and 20 that correspond to increases in 16, 24 and 29. This change represents a northward movement between larger centrally located strata. While strata 24 and 29 also increase in the fall under constant temperature, the corresponding decrease is primarily from strata 16 and 13. While similar results can be seen in the spring for the increasing temperature scenario, much more dramatic results exist in the fall under increasing temperature as we see a significant decreases in strata 13, 16, 21, and 22 that leads to the most noticeable increases in strata 17, 18, and 29. This shift represents movement from the shallower and more centrally located strata towards exterior deeper strata. Since stratum 16 contains very favorable habitat including much of the species' spawning ground, the strong shift out of 16 and into the northern most strata of 29 in the fall demonstrates a climate-driven change in movement preference.

$10/16\approx63$\% of the scenarios without covariates had a VAST fit with a lower relative error compared to the stratified mean estimate. The 6 covariate-free VAST estimates that resulted in a higher error than the stratified mean spanned all scenarios and seasons, with several fall errors being especially large (significant overestimates). Adding covariate information resulted in $14/16\approx88$\% of VAST estimates having improved error compared to the stratified mean. The 2 scenarios that procedure worse error spanned temperature scenarios, but were both in the spring season when the proportion of the population in each strata remained constant in each scenario.**why?? doesnt make sense. the values with cov are about the same as SM** Qualitatively, including covariate information has a larger impact on decreasing the relative error compared to the stratified mean compared to failing to include covariates. 



<font size="5">*Model / Estimate Ratio Results*</font>

A simple visual analysis of all error plots for each species reveals that VAST estimates tend to provide abundance estimates that are above the true model value, while the stratified mean estimates are, on average, too low. This can be further examined by viewing estimate/ratio ratio plots, where we divide the yearly abundance estimates by the true model value. In doing so we see that VAST estimates tend to remain closer to the desired value of 1 compared to stratified mean estimates, which can range as low as 0 and exhibit large yearly changes. 

A more careful analysis of individual yearly model/estimate ratios when all strata are included revealed that about 73\% of all VAST ratios were above 1 (27\% less than 1), with an average of 1.29 and a standard deviation of 0.21. On the other hand, 33\% of stratified mean estimates were above 1 with an average of 0.874 and a standard deviation of 0.12. There were seasonal differences in estimate ratios with spring VAST ratios producing (1.08,0.12), fall VAST ratios being (1.50,0.38), stratified mean spring ratios resulting in (0.91,0.10), and fall values of (0.84,0.16). The breakdown for individual species followed a similar pattern.

When the entire domain is sampled, adding covariates brings the estimate ratio closer to 1. However, when failing to sample the entire domain, adding covariates can decrease the accuracy of VAST estimates. When including all strata, the stratified mean produced (0.87,0.12), while adding covariates improved the VAST estimate ratio from (1.45,0.17) to (1.13,0.09). With a reduced number of strata, the stratified mean resulted in our worst summary values of (0.59,0.10), and adding covariates to our VAST models decreased the average ratio results from (1.04,0.33 ) to (0.78,0.19).


\section{Discussion}

Estimation methods that have large, inaccurate swings (stratified mean) can lead to changes in quotas that do not correspond to the true population trend, which could have a compounding effect (can lead to quotas that are too high/low given an incorrect assumption of increase/decrease in biomass). Our model has a constant assumed mortality that accounts for fishing and natural death and will not account for impacts of these decisions. VAST may provide more consistent biomass predictions(?) 

<!-- [[ some things that I think we'll need to address, in addition to those mentioned above are (in no particular order): -->
<!-- number of simulations done for each scenario - time required to do them and analyses -->
<!-- pros and cons of using VAST with covariates in a changing environment -->
<!-- implications for current practice of using stratified mean (not horrible, but might be able to do better with model-based using covariates if enviro changing, note we don't want to say stratified mean should not be used because that will draw a lot of tomato throwing) -->
<!-- future work - some of the ideas we've discussed already could be mentioned -->
<!-- limitations to our study -->
<!-- perhaps for discussion, but we should mention somewhere that MFS only tracks biomass not age structure, the latter is important for stock assessments but not considered in this paper -->
<!-- ]] -->

\section{Acknowledgements}
[[we should thank Jim (obviously), but also those who helped you with the habitat data (robyn, david Chev.) and others? also should note that funding provided by Climate-Groundfish source (I'll dig up the official name of the funding source)]] 

<!-- Funding source is "Northeast Fisheries and Climate program at the NEFSC" -->

## Data and Code Availability
All data and code used in this work are available at https://github.com/Blevy2/READ-PDB-blevy2-MFS2. 

## References


<div id="refs"></div>



\pagebreak

## Tables
</font>

\pagebreak


```{r PopPct, echo=FALSE,out.width="95%",fig.show='hold', fig.align='center', fig.cap="Percent of each species in each strata for during survey weeks in our spatial simulations. All constant temperature scenarios follow the patterns on the left while increasing temperature scenarios follow the patterns on the right.",out.width="47.5%"}
knitr::include_graphics(c("Images/PercentPlots_ConPopConTemp_YT.png","Images/PercentPlots_ConPopIncTemp_YT.png"))
knitr::include_graphics(c("Images/PercentPlots_DecPopConTemp_Cod.png","Images/PercentPlots_DecPopIncTemp_Cod.png"))
knitr::include_graphics(c("Images/PercentPlots_IncPopConTemp_Had.png","Images/PercentPlots_IncPopIncTemp_Had.png"))
```


<div align="center">Table 1. Parameters used in all population models.</div>

```{r paramsALL, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

tabl <- "
|	Parameter	|	Description | Unit |Yellowtail | Cod | Haddock | Source
|:---	|:------- |:-- |:--- |:-- |:-- |:--
| $\\rho$ | Ford's growth coefficient | wk$^{-1}$  | 4.48 | 4.43 | 4.49 | |
| $M$ | Natural Mortality| wk$^{-1}$  | 0.2064 | 0.2728 | 0.3340 | |
| $W_R$ |Weight of fully recruited fish| kg | 0.39 | 2.95 | 1.12 | |
| $W_{R-1}$ | Weight of pre-recruit fish| kg | 0.13 | 0.39 | 0.19 | |
| $\\sigma^2$ | Variance in recruited fish | kg$^2$ | 0.55 | 0.55 | 0.55 ||
| $\\lambda$ | Decay rate for movement | - | 0.7 | 0.7 | 0.7 ||
| $Spwn_s$ | Spawning weeks for species $s$ | wk | 9-12 | 8-13 | 11-14 ||
| $Rec_s$ | Recruitment weeks for species $s$ | wk | 9-12 | 8-13 | 11-14 ||
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion


```


```{r paramsALL2,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

param_table1 = read_csv("CSVs/Parameters1.csv")

summary_tab1 <- param_table1 %>% 
 # dplyr::mutate_if(is.numeric, list(~as.character(signif(., 3))))%>%
  
  mutate_if(grepl('rrr',.), ~replace(., grepl('rrr', .), paste("\U03C1")))#should be replacing r with the rho symbol
 # mutate_if(grepl('W1',.), ~replace(., grepl('W1', .), "WW")) #should be replacing beta with the symbol
 #    mutate_if(grepl('wk',.), ~replace(., grepl('wk', .), "1/wk")) %>% #should be replacing beta with the symbol
 #  

# Change the orientation of the table so that Species become the variable headings



# Create table to present the data]
Fig_1 <- kable(summary_tab1, 
  caption = "Parameters used in all population models.",
    format = "latex", booktabs = TRUE) %>%
  kable_styling(font_size = 10)
 
```


 ```{r, results='asis'}
 
 Fig_1
 
 ```


<!-- Table 2. Parameters used in models with relatively constant populations. -->
<!-- ```{r paramsCON, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'} -->
<!-- tabl <- " -->
<!-- |		|	Description | Yellowtail | Cod | Haddock  -->
<!-- |:---	|:------- |:--- |:-- |:-- |:-- -->
<!-- | $M+F$ | Adjusted Mortality (Natural + Fishing)| wk$^{-1}$  | 0.764 | 0.83 | 0.309 |  -->

<!-- " -->
<!-- cat(tabl) # output the table in a format good for HTML/PDF/docx conversion -->
<!-- ``` -->

<!-- Table 3. Parameters used in models with increasing populations. -->
<!-- ```{r paramsINC, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'} -->
<!-- tabl <- " -->
<!-- |		|	Description | Yellowtail | Cod | Haddock | Source -->
<!-- |:---	|:------- |:--- |:-- |:-- |:-- -->
<!-- | $M+F$ | Adjusted Mortality (Natural + Fishing)| wk$^{-1}$  | 0.564 | 0.372 |  0.134 |  -->

<!-- " -->
<!-- cat(tabl) # output the table in a format good for HTML/PDF/docx conversion -->
<!-- ``` -->


<!-- Table 4. Parameters used in models with decreasing populations. -->
<!-- ```{r paramsDEC, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'} -->
<!-- tabl <- " -->
<!-- |		|	Description | Yellowtail | Cod | Haddock | Source -->
<!-- |:---	|:------- |:--- |:-- |:-- |:-- -->
<!-- | $M+F$ | Adjusted Mortality (Natural + Fishing)| wk$^{-1}$  | 0.764 | 0.623 | 0.334 |  -->

<!-- " -->
<!-- cat(tabl) # output the table in a format good for HTML/PDF/docx conversion -->
<!-- ``` -->


<!-- DOESNT WORK!!
<!-- Table 2. Parameters used in population models for each scenario. -->
<!-- ```{r paramsSCENARIOS, echo=FALSE, message=TRUE, warnings=TRUE, results='asis'} -->
<!-- library(huxtable) -->

<!-- ht <- tribble_hux( -->
<!--   ~ "Section/topic", ~ "Item no", ~ "Checklist item", ~ "Reported on Page No", -->
<!--   "Title"          , ""         , ""                , "", -->
<!--   "Title"          , "1"        , "Identify..."     , "",  -->
<!--   "Abstract"       , ""         , ""                , "", -->
<!--   "Structured summary", "2"     , "Provide..."      , "" -->
<!--   # et cetera... -->
<!-- )  -->


<!-- # using the pipe from 4.1.0... -->

<!-- ht |>  -->
<!--   set_header_rows(c(2, 4), TRUE)                |> -->
<!--   merge_across(c(2, 4), everywhere)             |> -->
<!--   style_header_rows(bold = TRUE)                |> -->
<!--   set_all_borders(brdr(0.4, "solid", "grey70")) |> -->
<!--   set_background_color("grey97")                |> -->
<!--   set_background_color(1, 1:3, "grey90")        |> -->
<!--   set_col_width(c(0.2, 0.05, 0.55, 0.2))        |> -->
<!--   set_font("cmss")                               -->
<!-- ``` -->


<!-- ```{r,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'} -->


<!-- #orig_ui_deaths = read_csv("https://www.opendata.nhs.scot/dataset/b0135993-3d8a-4f3b-afcf-e01f4d52137c/resource/89807e07-fc5f-4b5e-a077-e4cf59491139/download/ui_deaths_2020.csv") -->

<!-- summary_tab <- orig_ui_deaths %>% -->
<!--   # Apply filters in same was as in plots so looking at one year, whole of Scotland, and exlucing "All" entries -->
<!--   filter(Year == "2018", HBR == "S92000003", AgeGroup != "All" & Sex != "All", InjuryType != "Accidental exposure" & InjuryType != "All") %>% -->
<!-- # Group the table according to injury type, age, and sex -->
<!--   group_by(InjuryType, AgeGroup, Sex) %>% -->
<!-- # Create a summary of total number of deaths for neater appearance to the table and demonstration of the figures -->
<!--   summarise(total_deaths = sum(NumberofDeaths)) %>% -->
<!-- # Change the orientation of the table so that age groups become the variable headings -->
<!--   pivot_wider(names_from = AgeGroup, values_from = total_deaths) %>% -->
<!--   mutate(Sex = factor(Sex)) %>% -->
<!--   arrange(Sex) %>% -->
<!--   select(Sex, everything()) -->

<!-- # Create table to present the data] -->
<!-- Fig_2 <- kable(summary_tab[, -1],  -->
<!--   caption = "Deaths from unintentional injuries in Scotland", -->
<!--     format = "latex", booktabs = TRUE) %>% -->
<!--   kable_styling(font_size = 10) %>% -->
<!--   pack_rows(tab_kable, colnum = 1, -->
<!--     index = table(fct_inorder(summary_tab$Sex), useNA = "no")) -->
<!-- ``` -->
<!-- ```{r, results='asis'} -->
<!-- Fig_2 -->
<!-- ``` -->



```{r paramsSCENARIOS,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

param_table = read_csv("CSVs/Parameters.csv")

summary_tab <- param_table %>% 
  dplyr::mutate_if(is.numeric, list(~as.character(signif(., 3))))%>%
  
 mutate_if(grepl('alpha',.), ~replace(., grepl('alpha', .), paste("\U03B1"))) %>% #should be replacing alpha with the symbol
  mutate_if(grepl('beta',.), ~replace(., grepl('beta', .), paste("\U03B2"))) %>% #should be replacing beta with the symbol
    mutate_if(grepl('wk',.), ~replace(., grepl('wk', .), "1/wk")) %>% #should be replacing beta with the symbol
  
# Group the table according to Parameter, Scenario
  group_by(Parameter, Scenario)%>%
# Change the orientation of the table so that Species become the variable headings
  pivot_wider(names_from = Species,  values_from = Value) %>%
  mutate(Scenario = factor(Scenario)) %>%
  arrange(Scenario) %>%
  select(Scenario, everything())



# Create table to present the data]
Fig_3 <- kable(summary_tab[, -1], 
  caption = "Parameters used in population models for each scenario.",
    format = "latex", booktabs = TRUE) %>%
  kable_styling(font_size = 10) %>%
  pack_rows(tab_kable, colnum = 1,
    index = table(fct_inorder(summary_tab$Scenario), useNA = "no"))
```
```{r, results='asis'}
Fig_3
```





<div align="center">Table XX. Parameters used in all VAST models.</div>

```{r VASTsettings, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}


tabl <- "
|	Parameter	|	Description | Settings A | Settings B
|:--	|:------- |:---- |:----
| *ObsModel* | Link function and assumed distribution | c(10,2) | c(10,2)
|FieldConfig | Specified spatial and/or spatio-temporal variation in predictors| c(Omega1=0, Epsilon1=0, Omega2=1, Epsilon2=1) | c(Omega1=0, Epsilon1=0, Omega2=1, Epsilon2=1)
| RhoConfig | Specifying whether intercepts or spatio-temporal variation is structured among time intervals | c(Beta1=3, Beta2=, Epsilon1=0, Epsilon2=4) | c(Beta1=3, Beta2=3, Epsilon1=0, Epsilon2=4)
| X1_formula | Right-sided formula affecting the 1st linear predictor  | X1_formula = ~ poly(Temp, degree=2 ) | N/A
| X2_formula | Right-sided formula affecting the 2nd linear predictor | X2_formula = ~ poly(Temp, degree=2 ) + poly(Habitat, degree=2 ) | X2_formula = ~ poly(Temp, degree=2 ) + poly(Habitat, degree=2 )


"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion


```






<!-- ```{r YT_results,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'} -->



<!-- result_table = read_csv("CSVs/Yellowtail_results_final.csv") -->

<!-- summary_tab <- result_table %>%  -->


<!-- # Group the table according to Parameter, Scenario -->
<!--   group_by(Scenario,Strata) -->



<!-- # Create table to present the data] -->
<!-- Fig_5 <- kable(summary_tab) %>% -->
<!--   kable_styling(font_size = 10)  %>% -->
<!--   pack_rows(tab_kable, colnum = c(1,4), -->
<!--     index = table(fct_inorder(summary_tab$Strata), useNA = "no")) %>% -->
<!--   pack_rows(tab_kable, colnum = 1, -->
<!--     index = table(fct_inorder(summary_tab$Scenario), useNA = "no"))  -->

<!-- ``` -->
<!-- ```{r, results='asis'} -->
<!-- Fig_5 -->
<!-- ``` -->


```{r YTresultsallstrata,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

#result_table = read_csv("CSVs/Yellowtail_results_final.csv")
result_table = read_csv("CSVs/Yellowtail_results_final_newsettings_forpaper.csv")



summary_tab_all <- result_table %>% 
  subset(Strata == "all")%>%
 # subset(Scenario=="Constant Population")%>%

#   group_by(`Temperature Scenario`)%>%
# # 
# #   group_by(Scenario)%>%
#   mutate(`Temperature Scenario` = factor(`Temperature Scenario`))%>%
#   
#   arrange(`Temperature Scenario`) %>%
  select(Scenario,`Temperature Scenario`,Season,Covariate,Noise,`VAST A`,`VAST B`, `Stratified Mean`) 



#COLOR INDIVIDUAL ROWS BY CATEGORY
#define colors


# summary_tab_all <- result_table %>% 
# # Group the table according to Parameter, Scenario
#   group_by(Scenario)%>%
#   mutate(Scenario = factor(Scenario)) %>%
#   arrange(Scenario) %>%
#   select(Scenario, everything())


# Create table to present the data]
Fig_5a <- kable(summary_tab_all[, -1],
      align = c("l", "l", "l", "l", "c", "c", "c"),
  caption = "Yellowtail flounder error results with all strata included in calculations. Row colors correspond to the same settings applied in different seasons.") %>%
  row_spec(0,bold = TRUE)%>% #bold column titles
  kable_styling(font_size = 10)  %>%
  pack_rows(tab_kable(), colnum = 1,
    index = table(fct_inorder(summary_tab_all$Scenario), useNA = "no"))%>%
  #color every 4th row a different color
  row_spec(seq(1,96,4), bold = T, color = "white", background = "black")%>%
  row_spec(seq(2,96,4), bold = T, color = "white", background = "#5C5E60")%>%
  row_spec(seq(3,96,4), bold = T, color = "white", background = "#A4A4A4")%>%
  row_spec(seq(4,96,4), bold = T, color = "white", background = "#D2D2D2")
  
```


```{r YTresultsreducedstrata,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

#result_table = read_csv("CSVs/Yellowtail_results_final.csv")
result_table = read_csv("CSVs/Yellowtail_results_final_newsettings_forpaper.csv")





summary_tab_exclude <- result_table %>% 
  subset(Strata == "reduced")%>%
 # subset(Scenario=="Constant Population")%>%

#   group_by(`Temperature Scenario`)%>%
# # 
# #   group_by(Scenario)%>%
#   mutate(`Temperature Scenario` = factor(`Temperature Scenario`))%>%
#   arrange(`Temperature Scenario`) %>%
  select(Scenario,`Temperature Scenario`,Season,Covariate,Noise,`VAST A`,`VAST B`, `Stratified Mean`) 

#COLOR INDIVIDUAL ROWS BY CATEGORY
#define colors


Fig_5b <- kable(summary_tab_exclude[, -1],
      align = c("l", "l", "l", "l", "c", "c", "c"),
  caption = "Yellowtail flounder error results with certain strata excluded from calculations. Row colors correspond to the same settings applied in different seasons.") %>%
  row_spec(0,bold = TRUE)%>% #bold column titles
  kable_styling(font_size = 10)  %>%
  pack_rows(tab_kable(), colnum = 1,
    index = table(fct_inorder(summary_tab_exclude$Scenario), useNA = "no"))%>%
  #color every 4th row a different color
   row_spec(seq(1,96,4), bold = T, color = "white", background = "black")%>%
  row_spec(seq(2,96,4), bold = T, color = "white", background = "#5C5E60")%>%
  row_spec(seq(3,96,4), bold = T, color = "white", background = "#A4A4A4")%>%
  row_spec(seq(4,96,4), bold = T, color = "white", background = "#D2D2D2");


```


```{r, results='asis'}
Fig_5a
```
```{r, results='asis'}
Fig_5b
```


```{r CodERROR,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

#param_table1 = read_csv("CSVs/Cod_results.csv")
param_table1 = read_csv("CSVs/Cod_results_newsettings_forpaper.csv") # not in repo

summary_tab1 <- param_table1 %>% 
# Group the table according to Parameter, Scenario
  group_by(Temp)%>%
  mutate(Temp = factor(Temp)) %>%
  arrange(Temp) %>%
  select(Temp, everything())




# Create table to present the data]
Fig_3a <-  kable(summary_tab1[, -1], 
  caption = "Cod error results.",
    format = "latex", booktabs = TRUE) %>%
  kable_styling(font_size = 10) %>%
  pack_rows(tab_kable(), colnum = 1,
    index = table(fct_inorder(summary_tab1$Temp), useNA = "no"))
```

```{r, results='asis'}
Fig_3a
```


```{r HadERROR,echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

#param_table1 = read_csv("CSVs/Haddock_results.csv")
param_table1 = read_csv("CSVs/Haddock_results_newsettings_forpaper.csv") # not in repo

summary_tab1 <- param_table1 %>% 
# Group the table according to Parameter, Scenario
  group_by(Temp)%>%
  mutate(Temp = factor(Temp)) %>%
  arrange(Temp) %>%
  select(Temp, everything())

# Create table to present the data]
Fig_3b <-  kable(summary_tab1[, -1], 
  caption = "Haddock error results.",
    format = "latex", booktabs = TRUE) %>%
  kable_styling(font_size = 10) %>%
  pack_rows(tab_kable(), colnum = 1,
    index = table(fct_inorder(summary_tab1$Temp), useNA = "no"))
```

```{r, results='asis'}
Fig_3b
```






<!-- ```{r PMsallscenarios, echo=FALSE, message=FALSE, warnings=FALSE, out.width='7in', fig.cap=figcap1} -->
<!-- #knitr::include_graphics(file.path(getwd(),"MS_tables_figs_rev1/final_ms_figs","Figure_1.pdf")) -->
<!-- ``` -->


<!-- ```{r SSmsyvsCMSY, echo=FALSE, message=FALSE, warnings=FALSE, out.width='7in', fig.cap=figcap2} -->
<!-- #knitr::include_graphics(file.path(getwd(),"MS_tables_figs_rev1/final_ms_figs","Figure_2.pdf")) -->
<!-- ``` -->


<!-- ```{r PMsbyretroF, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap=figcap3} -->
<!-- #knitr::include_graphics(file.path(getwd(),"MS_tables_figs_rev1/final_ms_figs","Figure_3.pdf")) -->
<!-- ``` -->


<!-- ```{r FFmsybyscenario, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap=figcap4} -->
<!-- #knitr::include_graphics(file.path(getwd(),"MS_tables_figs_rev1/final_ms_figs","Figure_4.pdf")) -->
<!-- ``` -->


<!-- ```{r linearvsdiffuse, echo=FALSE, message=FALSE, warnings=FALSE, out.width='7in', fig.cap=figcap5} -->
<!-- #knitr::include_graphics(file.path(getwd(),"MS_tables_figs_rev1/final_ms_figs","Figure_5.pdf")) -->
<!-- ``` -->

